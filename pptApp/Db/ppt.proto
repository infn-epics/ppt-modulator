# StreamDevice Protocol File for PPT Modulator Binary TCP Stream
# Total data size: 43 words (86 bytes)
# Each word is 2 bytes (LSB + MSB = little-endian 16-bit unsigned)
# Device responds on TCP port 2000

# Terminator for binary protocols
Terminator = "";
ReplyTimeout = 1000;
ReadTimeout = 500;
InTerminator="";
MaxInput = 0;            # maximum message length

# ============================================================================
# Read all available bytes into a waveform (variable length up to NELM)
# ============================================================================
readAllData {
    in "%r";             # read all available bytes (up to MaxInput/NELM)
}

# ============================================================================
# Write ON/OFF Command Word (bytes 0-1)
# ============================================================================
# Bit mapping (LSB first, little-endian 16-bit word):
# Bit 0:  ON: Heater Thyratron
# Bit 1:  ON: Heater Klystron 80% (Start of Timer 80%)
# Bit 2:  ON: Heater Klystron 100% (Start of Timer 100%)
# Bit 3:  ON: Focus power supply
# Bit 4:  ON: Premagnetisation power supply
# Bit 5:  ON: HVPS
# Bit 6:  ON: Charge PFN
# Bit 7:  ON: Reset
# Bit 8:  OFF: Heater Thyratron
# Bit 9:  OFF: Heater Klystron 80%
# Bit 10: OFF: Heater Klystron 100%
# Bit 11: OFF: Focus power supply
# Bit 12: OFF: Premagnetisation power supply
# Bit 13: OFF: HVPS
# Bit 14: OFF: Charge PFN
# Bit 15: OFF: Reset
writeOnOffCmd {
    out "%<w";           # write 16-bit little-endian word
}

# ============================================================================
# Write HVPS Charging Voltage Setpoint (bytes 2-3)
# ============================================================================
# Value range: 0..500 (representing 0..50.0kV)
# Example: 45.12kV => value = 451
writeHVPSVoltage {
    out "%<w";           # write 16-bit little-endian word
}

# ============================================================================
# NOTES:
# ============================================================================
# - Protocol reads all available bytes with %c into a UCHAR waveform
# - The %c format without a count reads until timeout, terminator, or MaxInput limit
# - MaxInput is set to 156 bytes, NELM on waveform is 86 bytes
# - StreamDevice will set the waveform's NORD field to actual bytes received
# - An aSub record processes the byte array and extracts all 22 values
# - All 16-bit words are little-endian (LSB first, then MSB)
# - Single TCP read, atomic snapshot, all values decoded in one subroutine
# - With Terminator="", reads until ReadTimeout (100ms) or MaxInput reached
# ============================================================================
